name: Deploy Backend (Cloud Run)

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      REGION: ${{ secrets.GCP_REGION }}
      # Environment mapping based on branch
      PROJECT_ID: ${{ github.ref == 'refs/heads/main' && secrets.GCP_PROJECT_ID_PROD || secrets.GCP_PROJECT_ID_STAGING }}
      SERVICE_NAME: ${{ github.ref == 'refs/heads/main' && secrets.CLOUD_RUN_SERVICE_PROD || secrets.CLOUD_RUN_SERVICE_STAGING }}

      # Application environment variables
      CORS_ORIGINS: ${{ github.ref == 'refs/heads/main' && secrets.CORS_ORIGINS_PROD || secrets.CORS_ORIGINS_STAGING }}
      STRIPE_SECRET_KEY: ${{ github.ref == 'refs/heads/main' && secrets.STRIPE_SECRET_KEY_PROD || secrets.STRIPE_SECRET_KEY_STAGING }}
      STRIPE_WEBHOOK_SECRET: ${{ github.ref == 'refs/heads/main' && secrets.STRIPE_WEBHOOK_SECRET_PROD || secrets.STRIPE_WEBHOOK_SECRET_STAGING }}
      NODE_ENV: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Build (if applicable)
        working-directory: backend
        run: npm run build --if-present

      - name: Setup gcloud authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ github.ref == 'refs/heads/main' && secrets.GCP_SA_KEY_PROD || secrets.GCP_SA_KEY_STAGING }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # Generate version.json for /version endpoint
      - name: Generate version metadata
        working-directory: backend
        run: |
          cat > version.json <<EOF
          {
            "version": "${{ github.sha }}",
            "shortSha": "${GITHUB_SHA:0:7}",
            "branch": "${{ github.ref_name }}",
            "builtAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "buildNumber": "${{ github.run_number }}",
            "environment": "${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}"
          }
          EOF
          cat version.json

      - name: Deploy to Cloud Run (source-based)
        working-directory: backend
        run: |
          gcloud run deploy "$SERVICE_NAME" \
            --region="$REGION" \
            --source . \
            --platform=managed \
            --allow-unauthenticated \
            --memory=512Mi \
            --timeout=30s \
            --ingress=all \
            --min-instances=${{ github.ref == 'refs/heads/main' && '1' || '0' }} \
            --set-env-vars="NODE_ENV=${NODE_ENV},GIT_SHA=${{ github.sha }},BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --set-env-vars="STAGE=${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}" \
            --set-env-vars="CORS_ORIGINS_STAGING=${{ secrets.CORS_ORIGINS_STAGING }}" \
            --set-env-vars="CORS_ORIGINS_PROD=${{ secrets.CORS_ORIGINS_PROD }}" \
            --set-env-vars="CORS_ORIGINS=${CORS_ORIGINS}" \
            --set-env-vars="STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY},STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}" \
            --set-env-vars="ENABLE_DOCS=${{ github.ref == 'refs/heads/main' && secrets.ENABLE_DOCS_PROD || 'true' }}"

      # Get deployed service URL for smoke tests
      - name: Get Service URL
        id: url
        run: |
          URL=$(gcloud run services describe "$SERVICE_NAME" --region "$REGION" --format='value(status.url)')
          echo "SERVICE_URL=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Service URL: $URL"

      # Smoke test suite - verify critical endpoints
      - name: Smoke Test - Health Check
        run: |
          echo "ğŸ” Testing /healthz endpoint..."
          curl -fsSL "${{ steps.url.outputs.SERVICE_URL }}/healthz" | jq .
          
      - name: Smoke Test - Readiness Check
        run: |
          echo "ğŸ” Testing /readiness endpoint..."
          curl -fsSL "${{ steps.url.outputs.SERVICE_URL }}/readiness" | jq .

      - name: Smoke Test - Version Info
        run: |
          echo "ğŸ” Testing /version endpoint..."
          RESPONSE=$(curl -fsSL "${{ steps.url.outputs.SERVICE_URL }}/version")
          echo "$RESPONSE" | jq .
          
          # Verify deployed version matches current commit
          DEPLOYED_SHA=$(echo "$RESPONSE" | jq -r '.version')
          if [ "$DEPLOYED_SHA" != "${{ github.sha }}" ]; then
            echo "âš ï¸ Warning: Deployed SHA ($DEPLOYED_SHA) doesn't match expected (${{ github.sha }})"
          else
            echo "âœ… Version verification passed"
          fi

      - name: Smoke Test - Cache Metrics
        run: |
          echo "ğŸ” Testing /metrics/cache endpoint..."
          curl -fsSL "${{ steps.url.outputs.SERVICE_URL }}/metrics/cache" | jq .

      # Canary deployment for production (10% traffic split)
      # Only runs on main branch if CANARY variable is true
      - name: Canary Deploy (10% traffic)
        if: ${{ github.ref == 'refs/heads/main' && vars.CANARY == 'true' }}
        run: |
          echo "ğŸ¤ Starting canary deployment (10% traffic)..."
          
          # Get latest revision name
          LATEST_REV=$(gcloud run services describe "$SERVICE_NAME" \
            --region "$REGION" \
            --format='value(status.latestReadyRevisionName)')
          
          echo "Latest revision: $LATEST_REV"
          
          # Split traffic: 10% to new revision, 90% to previous
          gcloud run services update-traffic "$SERVICE_NAME" \
            --region "$REGION" \
            --to-revisions "$LATEST_REV=10" \
            --to-latest=90
          
          echo "âœ… Canary deployment active - 10% traffic to revision $LATEST_REV"
          echo "ğŸ’¡ Monitor metrics, then promote with: gcloud run services update-traffic $SERVICE_NAME --to-latest"

      - name: Deployment summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment completed successfully"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Environment: ${{ github.ref == 'refs/heads/main' && 'PRODUCTION' || 'STAGING' }}"
          echo "ğŸš€ Service: $SERVICE_NAME"
          echo "ğŸ“ Region: $REGION"
          echo "ğŸ”— URL: ${{ steps.url.outputs.SERVICE_URL }}"
          echo "ğŸ“¦ Version: ${{ github.sha }}"
          echo "ğŸ—ï¸ Build: #${{ github.run_number }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
